/**\n * Audit Pack Service\n * \n * Generate audit trails and compliance reports\n * Feature 11: Audit trail logging\n */\n\nconst AuditLog = require('../db/models/AuditLog');\nconst logger = require('../utils/logger');\n\nclass AuditPackService {\n  /**\n   * Generate audit report for entity\n   */\n  static async generateEntityAudit(entityType, entityId) {\n    try {\n      const logs = await AuditLog.getByEntity(entityType, entityId);\n      const report = {\n        entityType,\n        entityId,\n        totalActions: logs.length,\n        actions: logs,\n        timeRange: {\n          earliest: logs.length > 0 ? logs[logs.length - 1].created_at : null,\n          latest: logs.length > 0 ? logs[0].created_at : null,\n        },\n        actionCounts: this._countActions(logs),\n      };\n      return report;\n    } catch (error) {\n      logger.error('Error generating entity audit', { error: error.message });\n      throw error;\n    }\n  }\n\n  /**\n   * Generate audit report for user activities\n   */\n  static async generateUserAudit(userId, startDate, endDate) {\n    try {\n      const filters = { userId, startDate, endDate };\n      const logs = await AuditLog.getAll(filters);\n      const report = {\n        userId,\n        period: { startDate, endDate },\n        totalActions: logs.length,\n        actions: logs,\n        actionCounts: this._countActions(logs),\n        entityBreakdown: this._groupByEntity(logs),\n      };\n      return report;\n    } catch (error) {\n      logger.error('Error generating user audit', { error: error.message });\n      throw error;\n    }\n  }\n\n  /**\n   * Generate compliance audit for date range\n   */\n  static async generateComplianceAudit(startDate, endDate) {\n    try {\n      const logs = await AuditLog.getByDateRange(startDate, endDate);\n      const report = {\n        period: { startDate, endDate },\n        totalActions: logs.length,\n        userCount: new Set(logs.map((l) => l.user_id)).size,\n        actions: logs,\n        actionCounts: this._countActions(logs),\n        userActivity: this._groupByUser(logs),\n        entityActivity: this._groupByEntity(logs),\n        criticalActions: this._filterCriticalActions(logs),\n      };\n      return report;\n    } catch (error) {\n      logger.error('Error generating compliance audit', { error: error.message });\n      throw error;\n    }\n  }\n\n  /**\n   * Count occurrences of each action type\n   */\n  static _countActions(logs) {\n    return logs.reduce((counts, log) => {\n      counts[log.action] = (counts[log.action] || 0) + 1;\n      return counts;\n    }, {});\n  }\n\n  /**\n   * Group logs by entity type\n   */\n  static _groupByEntity(logs) {\n    return logs.reduce((groups, log) => {\n      if (!groups[log.entity_type]) {\n        groups[log.entity_type] = [];\n      }\n      groups[log.entity_type].push(log);\n      return groups;\n    }, {});\n  }\n\n  /**\n   * Group logs by user\n   */\n  static _groupByUser(logs) {\n    return logs.reduce((groups, log) => {\n      if (!groups[log.user_id]) {\n        groups[log.user_id] = [];\n      }\n      groups[log.user_id].push(log);\n      return groups;\n    }, {});\n  }\n\n  /**\n   * Filter critical actions (create, delete, approve, reject)\n   */\n  static _filterCriticalActions(logs) {\n    const criticalActions = ['create', 'delete', 'approve', 'reject'];\n    return logs.filter((log) => criticalActions.includes(log.action));\n  }\n}\n\nmodule.exports = AuditPackService;\n"
