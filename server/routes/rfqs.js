/**\n * RFQ Routes\n * \n * API endpoints for Request for Quotation management\n * Feature 3: RFQ creation and management\n */\n\nconst express = require('express');\nconst router = express.Router();\nconst RFQ = require('../db/models/RFQ');\nconst Submission = require('../db/models/Submission');\nconst Clarification = require('../db/models/Clarification');\nconst { verifyToken, checkPermission } = require('../middleware/auth');\nconst { validateBody } = require('../middleware/validation');\nconst { logCreate, logUpdate, logDelete, logApproval } = require('../middleware/auditLogger');\nconst logger = require('../utils/logger');\nconst { RFQ_SCHEMA, SUBMISSION_SCHEMA, CLARIFICATION_SCHEMA } = require('../shared/validation-rules');\nconst { PERMISSIONS } = require('../config/permissions');\n\n// ============ RFQ ENDPOINTS ============\n\n/**\n * Get all RFQs\n * GET /api/rfqs\n */\nrouter.get('/', verifyToken, async (req, res, next) => {\n  try {\n    const filters = {};\n    if (req.query.status) filters.status = req.query.status;\n    if (req.query.procurementId) filters.procurementId = req.query.procurementId;\n\n    const rfqs = await RFQ.getAll(filters);\n    res.json({\n      success: true,\n      data: rfqs,\n      count: rfqs.length,\n    });\n  } catch (error) {\n    logger.error('Error fetching RFQs', { error: error.message });\n    res.status(500).json({ success: false, message: 'Error fetching RFQs' });\n  }\n});\n\n/**\n * Get RFQ by ID\n * GET /api/rfqs/:id\n */\nrouter.get('/:id', verifyToken, async (req, res, next) => {\n  try {\n    const rfq = await RFQ.findById(req.params.id);\n    if (!rfq) {\n      return res.status(404).json({ success: false, message: 'RFQ not found' });\n    }\n    res.json({ success: true, data: rfq });\n  } catch (error) {\n    logger.error('Error fetching RFQ', { error: error.message });\n    res.status(500).json({ success: false, message: 'Error fetching RFQ' });\n  }\n});\n\n/**\n * Create RFQ\n * POST /api/rfqs\n */\nrouter.post(\n  '/',\n  verifyToken,\n  checkPermission(PERMISSIONS.PUBLISH_RFQ),\n  validateBody(RFQ_SCHEMA),\n  logCreate('RFQ'),\n  async (req, res, next) => {\n    try {\n      const rfq = await RFQ.create({\n        procurementId: req.body.procurementId,\n        title: req.body.title,\n        description: req.body.description,\n        status: 'draft',\n        publishDate: req.body.publishDate,\n        closingDate: req.body.closingDate,\n        createdBy: req.user.id,\n        evaluationCriteria: req.body.evaluationCriteria,\n      });\n      res.status(201).json({ success: true, data: rfq });\n    } catch (error) {\n      logger.error('Error creating RFQ', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error creating RFQ' });\n    }\n  }\n);\n\n/**\n * Update RFQ\n * PUT /api/rfqs/:id\n */\nrouter.put(\n  '/:id',\n  verifyToken,\n  checkPermission(PERMISSIONS.PUBLISH_RFQ),\n  validateBody(RFQ_SCHEMA),\n  logUpdate('RFQ'),\n  async (req, res, next) => {\n    try {\n      const rfq = await RFQ.update(req.params.id, req.body);\n      if (!rfq) {\n        return res.status(404).json({ success: false, message: 'RFQ not found' });\n      }\n      res.json({ success: true, data: rfq });\n    } catch (error) {\n      logger.error('Error updating RFQ', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error updating RFQ' });\n    }\n  }\n);\n\n/**\n * Publish RFQ\n * PATCH /api/rfqs/:id/publish\n */\nrouter.patch(\n  '/:id/publish',\n  verifyToken,\n  checkPermission(PERMISSIONS.PUBLISH_RFQ),\n  logApproval('RFQ'),\n  async (req, res, next) => {\n    try {\n      const rfq = await RFQ.update(req.params.id, {\n        status: 'published',\n        publish_date: new Date(),\n      });\n      res.json({ success: true, data: rfq });\n    } catch (error) {\n      logger.error('Error publishing RFQ', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error publishing RFQ' });\n    }\n  }\n);\n\n/**\n * Delete RFQ\n * DELETE /api/rfqs/:id\n */\nrouter.delete(\n  '/:id',\n  verifyToken,\n  checkPermission(PERMISSIONS.PUBLISH_RFQ),\n  logDelete('RFQ'),\n  async (req, res, next) => {\n    try {\n      await RFQ.delete(req.params.id);\n      res.json({ success: true, message: 'RFQ deleted' });\n    } catch (error) {\n      logger.error('Error deleting RFQ', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error deleting RFQ' });\n    }\n  }\n);\n\n// ============ SUBMISSION ENDPOINTS ============\n\n/**\n * Get submissions by RFQ\n * GET /api/rfqs/:rfqId/submissions\n */\nrouter.get('/:rfqId/submissions', verifyToken, async (req, res, next) => {\n  try {\n    const submissions = await Submission.getByRFQ(req.params.rfqId);\n    res.json({ success: true, data: submissions, count: submissions.length });\n  } catch (error) {\n    logger.error('Error fetching submissions', { error: error.message });\n    res.status(500).json({ success: false, message: 'Error fetching submissions' });\n  }\n});\n\n/**\n * Create submission\n * POST /api/rfqs/:rfqId/submissions\n */\nrouter.post(\n  '/:rfqId/submissions',\n  verifyToken,\n  validateBody(SUBMISSION_SCHEMA),\n  logCreate('Submission'),\n  async (req, res, next) => {\n    try {\n      const submission = await Submission.create({\n        rfqId: req.params.rfqId,\n        vendorId: req.user.id,\n        submissionDate: new Date(),\n        quotedPrice: req.body.quotedPrice,\n        technicalProposal: req.body.technicalProposal,\n        financialProposal: req.body.financialProposal,\n        attachments: req.body.attachments,\n        status: 'submitted',\n      });\n      res.status(201).json({ success: true, data: submission });\n    } catch (error) {\n      logger.error('Error creating submission', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error creating submission' });\n    }\n  }\n);\n\n// ============ CLARIFICATION ENDPOINTS ============\n\n/**\n * Get clarifications by RFQ\n * GET /api/rfqs/:rfqId/clarifications\n */\nrouter.get('/:rfqId/clarifications', verifyToken, async (req, res, next) => {\n  try {\n    const clarifications = await Clarification.getByRFQ(req.params.rfqId);\n    res.json({ success: true, data: clarifications, count: clarifications.length });\n  } catch (error) {\n    logger.error('Error fetching clarifications', { error: error.message });\n    res.status(500).json({ success: false, message: 'Error fetching clarifications' });\n  }\n});\n\n/**\n * Post clarification question\n * POST /api/rfqs/:rfqId/clarifications\n */\nrouter.post(\n  '/:rfqId/clarifications',\n  verifyToken,\n  validateBody(CLARIFICATION_SCHEMA),\n  logCreate('Clarification'),\n  async (req, res, next) => {\n    try {\n      const clarification = await Clarification.create({\n        rfqId: req.params.rfqId,\n        vendorId: req.user.id,\n        question: req.body.question,\n        status: 'pending',\n        postedDate: new Date(),\n      });\n      res.status(201).json({ success: true, data: clarification });\n    } catch (error) {\n      logger.error('Error posting clarification', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error posting clarification' });\n    }\n  }\n);\n\n/**\n * Respond to clarification\n * PATCH /api/rfqs/:rfqId/clarifications/:clarId\n */\nrouter.patch(\n  '/:rfqId/clarifications/:clarId',\n  verifyToken,\n  checkPermission(PERMISSIONS.PUBLISH_RFQ),\n  async (req, res, next) => {\n    try {\n      const clarification = await Clarification.update(req.params.clarId, {\n        response: req.body.response,\n        response_date: new Date(),\n        status: 'answered',\n      });\n      res.json({ success: true, data: clarification });\n    } catch (error) {\n      logger.error('Error responding to clarification', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error responding to clarification' });\n    }\n  }\n);\n\nmodule.exports = router;\n"
