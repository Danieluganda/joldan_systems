/**\n * Procurements Routes\n * \n * API endpoints for procurement management\n * Feature 1: Procurement planning and setup\n */\n\nconst express = require('express');\nconst router = express.Router();\nconst Procurement = require('../db/models/Procurement');\nconst Plan = require('../db/models/Plan');\nconst { verifyToken, checkPermission } = require('../middleware/auth');\nconst { validateBody } = require('../middleware/validation');\nconst { logCreate, logUpdate, logDelete } = require('../middleware/auditLogger');\nconst logger = require('../utils/logger');\nconst { PROCUREMENT_SCHEMA, PLAN_SCHEMA } = require('../shared/validation-rules');\nconst { PERMISSIONS } = require('../config/permissions');\n\n// ============ PROCUREMENT ENDPOINTS ============\n\n/**\n * Get all procurements\n * GET /api/procurements\n */\nrouter.get('/', verifyToken, async (req, res, next) => {\n  try {\n    const filters = {};\n    if (req.query.status) filters.status = req.query.status;\n    if (req.query.type) filters.procurementType = req.query.type;\n\n    const procurements = await Procurement.getAll(filters);\n    res.json({\n      success: true,\n      data: procurements,\n      count: procurements.length,\n    });\n  } catch (error) {\n    logger.error('Error fetching procurements', { error: error.message });\n    res.status(500).json({ success: false, message: 'Error fetching procurements' });\n  }\n});\n\n/**\n * Get procurement by ID\n * GET /api/procurements/:id\n */\nrouter.get('/:id', verifyToken, async (req, res, next) => {\n  try {\n    const procurement = await Procurement.findById(req.params.id);\n    if (!procurement) {\n      return res.status(404).json({ success: false, message: 'Procurement not found' });\n    }\n    res.json({ success: true, data: procurement });\n  } catch (error) {\n    logger.error('Error fetching procurement', { error: error.message });\n    res.status(500).json({ success: false, message: 'Error fetching procurement' });\n  }\n});\n\n/**\n * Create procurement\n * POST /api/procurements\n */\nrouter.post(\n  '/',\n  verifyToken,\n  checkPermission(PERMISSIONS.CREATE_PROCUREMENT),\n  validateBody(PROCUREMENT_SCHEMA),\n  logCreate('Procurement'),\n  async (req, res, next) => {\n    try {\n      const procurement = await Procurement.create({\n        title: req.body.title,\n        description: req.body.description,\n        procurementType: req.body.procurementType,\n        status: 'planning',\n        budget: req.body.budget,\n        plannedDate: req.body.plannedDate,\n        createdBy: req.user.id,\n        departmentId: req.body.departmentId,\n      });\n      res.status(201).json({ success: true, data: procurement });\n    } catch (error) {\n      logger.error('Error creating procurement', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error creating procurement' });\n    }\n  }\n);\n\n/**\n * Update procurement\n * PUT /api/procurements/:id\n */\nrouter.put(\n  '/:id',\n  verifyToken,\n  checkPermission(PERMISSIONS.CREATE_PROCUREMENT),\n  validateBody(PROCUREMENT_SCHEMA),\n  logUpdate('Procurement'),\n  async (req, res, next) => {\n    try {\n      const procurement = await Procurement.update(req.params.id, req.body);\n      if (!procurement) {\n        return res.status(404).json({ success: false, message: 'Procurement not found' });\n      }\n      res.json({ success: true, data: procurement });\n    } catch (error) {\n      logger.error('Error updating procurement', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error updating procurement' });\n    }\n  }\n);\n\n/**\n * Delete procurement\n * DELETE /api/procurements/:id\n */\nrouter.delete(\n  '/:id',\n  verifyToken,\n  checkPermission(PERMISSIONS.CREATE_PROCUREMENT),\n  logDelete('Procurement'),\n  async (req, res, next) => {\n    try {\n      await Procurement.delete(req.params.id);\n      res.json({ success: true, message: 'Procurement deleted' });\n    } catch (error) {\n      logger.error('Error deleting procurement', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error deleting procurement' });\n    }\n  }\n);\n\n// ============ PLAN ENDPOINTS ============\n\n/**\n * Get plans by procurement\n * GET /api/procurements/:procurementId/plans\n */\nrouter.get('/:procurementId/plans', verifyToken, async (req, res, next) => {\n  try {\n    const plans = await Plan.getByProcurement(req.params.procurementId);\n    res.json({ success: true, data: plans, count: plans.length });\n  } catch (error) {\n    logger.error('Error fetching plans', { error: error.message });\n    res.status(500).json({ success: false, message: 'Error fetching plans' });\n  }\n});\n\n/**\n * Create plan\n * POST /api/procurements/:procurementId/plans\n */\nrouter.post(\n  '/:procurementId/plans',\n  verifyToken,\n  checkPermission(PERMISSIONS.CREATE_PROCUREMENT),\n  validateBody(PLAN_SCHEMA),\n  logCreate('Plan'),\n  async (req, res, next) => {\n    try {\n      const plan = await Plan.create({\n        procurementId: req.params.procurementId,\n        planName: req.body.planName,\n        itemDescription: req.body.itemDescription,\n        estimatedValue: req.body.estimatedValue,\n        quantity: req.body.quantity,\n        deliveryDate: req.body.deliveryDate,\n        specifications: req.body.specifications,\n      });\n      res.status(201).json({ success: true, data: plan });\n    } catch (error) {\n      logger.error('Error creating plan', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error creating plan' });\n    }\n  }\n);\n\n/**\n * Update plan\n * PUT /api/procurements/:procurementId/plans/:planId\n */\nrouter.put(\n  '/:procurementId/plans/:planId',\n  verifyToken,\n  checkPermission(PERMISSIONS.CREATE_PROCUREMENT),\n  validateBody(PLAN_SCHEMA),\n  logUpdate('Plan'),\n  async (req, res, next) => {\n    try {\n      const plan = await Plan.update(req.params.planId, req.body);\n      if (!plan) {\n        return res.status(404).json({ success: false, message: 'Plan not found' });\n      }\n      res.json({ success: true, data: plan });\n    } catch (error) {\n      logger.error('Error updating plan', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error updating plan' });\n    }\n  }\n);\n\n/**\n * Delete plan\n * DELETE /api/procurements/:procurementId/plans/:planId\n */\nrouter.delete(\n  '/:procurementId/plans/:planId',\n  verifyToken,\n  checkPermission(PERMISSIONS.CREATE_PROCUREMENT),\n  logDelete('Plan'),\n  async (req, res, next) => {\n    try {\n      await Plan.delete(req.params.planId);\n      res.json({ success: true, message: 'Plan deleted' });\n    } catch (error) {\n      logger.error('Error deleting plan', { error: error.message });\n      res.status(500).json({ success: false, message: 'Error deleting plan' });\n    }\n  }\n);\n\nmodule.exports = router;\n"
