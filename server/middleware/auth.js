/**\n * Authentication Middleware\n * \n * JWT token verification and user authentication\n * Feature 5: User authentication and authorization\n */\n\nconst jwt = require('jsonwebtoken');\nconst logger = require('../utils/logger');\nconst { JWT_SECRET } = require('../config/env');\nconst { hasPermission } = require('../config/permissions');\n\n/**\n * Verify JWT token\n */\nconst verifyToken = (req, res, next) => {\n  try {\n    const token = req.headers.authorization?.split(' ')[1];\n\n    if (!token) {\n      return res.status(401).json({ error: 'No token provided' });\n    }\n\n    const decoded = jwt.verify(token, JWT_SECRET);\n    req.user = decoded;\n    next();\n  } catch (error) {\n    logger.error('Token verification failed', { error: error.message });\n    res.status(401).json({ error: 'Invalid or expired token' });\n  }\n};\n\n/**\n * Check if user has specific permission\n */\nconst checkPermission = (requiredPermission) => {\n  return (req, res, next) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'User not authenticated' });\n    }\n\n    if (!hasPermission(req.user.role, requiredPermission)) {\n      logger.warn('Permission denied', {\n        userId: req.user.id,\n        role: req.user.role,\n        requiredPermission,\n      });\n      return res.status(403).json({ error: 'Permission denied' });\n    }\n\n    next();\n  };\n};\n\n/**\n * Check if user has any of multiple permissions\n */\nconst checkAnyPermission = (requiredPermissions) => {\n  return (req, res, next) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'User not authenticated' });\n    }\n\n    const hasAny = requiredPermissions.some((perm) =>\n      hasPermission(req.user.role, perm)\n    );\n\n    if (!hasAny) {\n      logger.warn('Permission denied - no matching permissions', {\n        userId: req.user.id,\n        role: req.user.role,\n        requiredPermissions,\n      });\n      return res.status(403).json({ error: 'Permission denied' });\n    }\n\n    next();\n  };\n};\n\nmodule.exports = {\n  verifyToken,\n  checkPermission,\n  checkAnyPermission,\n};\n"
