/**\n * Audit Logger Middleware\n * \n * Logs all state-changing operations for compliance and audit trails\n * Feature 11: Audit trail logging\n */\n\nconst logger = require('../utils/logger');\nconst AuditLog = require('../db/models/AuditLog');\n\n/**\n * Log entity creation\n */\nconst logCreate = (entityType) => {\n  return async (req, res, next) => {\n    // Capture response to log what was created\n    const originalJson = res.json;\n    res.json = async function (data) {\n      try {\n        if (data.success && data.data) {\n          await AuditLog.create({\n            userId: req.user?.id,\n            action: 'create',\n            entityType,\n            entityId: data.data.id,\n            oldValues: null,\n            newValues: JSON.stringify(data.data),\n            ipAddress: req.ip,\n            description: `Created new ${entityType}: ${data.data.title || data.data.name || ''}`,\n          });\n        }\n      } catch (error) {\n        logger.error('Failed to log create audit', { error: error.message });\n      }\n\n      return originalJson.call(this, data);\n    };\n\n    next();\n  };\n};\n\n/**\n * Log entity update\n */\nconst logUpdate = (entityType) => {\n  return async (req, res, next) => {\n    // Store original data for comparison\n    const originalData = JSON.stringify(req.body);\n\n    const originalJson = res.json;\n    res.json = async function (data) {\n      try {\n        if (data.success && data.data) {\n          await AuditLog.create({\n            userId: req.user?.id,\n            action: 'update',\n            entityType,\n            entityId: data.data.id,\n            oldValues: originalData,\n            newValues: JSON.stringify(data.data),\n            ipAddress: req.ip,\n            description: `Updated ${entityType} ID: ${data.data.id}`,\n          });\n        }\n      } catch (error) {\n        logger.error('Failed to log update audit', { error: error.message });\n      }\n\n      return originalJson.call(this, data);\n    };\n\n    next();\n  };\n};\n\n/**\n * Log entity deletion\n */\nconst logDelete = (entityType) => {\n  return async (req, res, next) => {\n    const originalJson = res.json;\n    res.json = async function (data) {\n      try {\n        if (data.success) {\n          await AuditLog.create({\n            userId: req.user?.id,\n            action: 'delete',\n            entityType,\n            entityId: req.params.id,\n            oldValues: null,\n            newValues: null,\n            ipAddress: req.ip,\n            description: `Deleted ${entityType} ID: ${req.params.id}`,\n          });\n        }\n      } catch (error) {\n        logger.error('Failed to log delete audit', { error: error.message });\n      }\n\n      return originalJson.call(this, data);\n    };\n\n    next();\n  };\n};\n\n/**\n * Log approval action\n */\nconst logApproval = (entityType) => {\n  return async (req, res, next) => {\n    const originalJson = res.json;\n    res.json = async function (data) {\n      try {\n        if (data.success && data.data) {\n          await AuditLog.create({\n            userId: req.user?.id,\n            action: 'approve',\n            entityType,\n            entityId: data.data.id,\n            oldValues: JSON.stringify({ status: req.body.oldStatus }),\n            newValues: JSON.stringify(data.data),\n            ipAddress: req.ip,\n            description: `Approved ${entityType}: ${req.body.approvalReason || 'Approved'}`,\n          });\n        }\n      } catch (error) {\n        logger.error('Failed to log approval audit', { error: error.message });\n      }\n\n      return originalJson.call(this, data);\n    };\n\n    next();\n  };\n};\n\n/**\n * Log rejection action\n */\nconst logRejection = (entityType) => {\n  return async (req, res, next) => {\n    const originalJson = res.json;\n    res.json = async function (data) {\n      try {\n        if (data.success && data.data) {\n          await AuditLog.create({\n            userId: req.user?.id,\n            action: 'reject',\n            entityType,\n            entityId: data.data.id,\n            oldValues: JSON.stringify({ status: req.body.oldStatus }),\n            newValues: JSON.stringify(data.data),\n            ipAddress: req.ip,\n            description: `Rejected ${entityType}: ${req.body.rejectionReason || 'Rejected'}`,\n          });\n        }\n      } catch (error) {\n        logger.error('Failed to log rejection audit', { error: error.message });\n      }\n\n      return originalJson.call(this, data);\n    };\n\n    next();\n  };\n};\n\nmodule.exports = {\n  logCreate,\n  logUpdate,\n  logDelete,\n  logApproval,\n  logRejection,\n};\n"
